
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>single cell tracking with napari &#8212; napari tutorials</title>
    
  <link rel="stylesheet" href="../_static/css/index.f658d18f9b420779cfdf24aa0a7e2d77.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.40e2e510f6b7d1648584402491bb10fe.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.d3f166471bb80abb5163.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d31b09fe5c1d09cb49b26a786de4a05d.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Napari + ImageJ How-to-Guide" href="napari_imageJ.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  <img src="../_static/logo.ico" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">napari tutorials</h1>
  
</a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../index.html">
   napari tutorials
  </a>
 </li>
</ul>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../gallery.html">
   napari gallery
  </a>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../fundamentals/README.html">
   Fundamentals
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../fundamentals/installation.html">
     napari installation tutorial
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../fundamentals/getting_started.html">
     getting started with napari
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../fundamentals/viewer.html">
     napari viewer tutorial
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../fundamentals/image.html">
     image layer tutorial
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../fundamentals/labels.html">
     labels layer tutorial
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../fundamentals/points.html">
     points layer tutorial
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../fundamentals/shapes.html">
     shapes layer tutorial
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../fundamentals/surface.html">
     surface layer tutorial
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../fundamentals/tracks.html">
     tracks layer tutorial
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../fundamentals/vectors.html">
     vectors layer tutorial
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1 current active collapsible-parent">
  <a class="reference internal" href="README.html">
   Applications
  </a>
  <ul class="current collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="annotate_segmentation.html">
     annotating segmentation with text and bounding boxes
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="annotate_points.html">
     annotating videos with napari
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="dask.html">
     using dask and napari to process &amp; view large datasets
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="napari_imageJ.html">
     Napari + ImageJ How-to-Guide
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     single cell tracking with napari
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/applications/cell_tracking.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

        <!-- Source interaction buttons -->


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#cell-tracking-challenge-data">
   1. cell tracking challenge data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#extracting-the-tracks-from-the-dataset">
     extracting the tracks from the dataset
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#calculating-the-graph-using-the-lineage-information">
     calculating the graph using the lineage information
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#traversing-the-lineage-trees-to-identify-the-root-nodes">
     traversing the lineage trees to identify the root nodes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#visualizing-the-tracks-with-napari">
     visualizing the tracks with napari
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#using-btrack-to-track-cells">
   2. using
   <code class="docutils literal notranslate">
    <span class="pre">
     btrack
    </span>
   </code>
   to track cells
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   summary
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#further-reading">
   further reading
  </a>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="single-cell-tracking-with-napari">
<h1>single cell tracking with napari<a class="headerlink" href="#single-cell-tracking-with-napari" title="Permalink to this headline">¶</a></h1>
<p>In this application note, we will use napari (requires version 0.4.0 or greater) to visualize single cell tracking data using the <code class="docutils literal notranslate"><span class="pre">Tracks</span></code> layer. For an overview of the <code class="docutils literal notranslate"><span class="pre">Tracks</span></code> layer, please see the <a class="reference internal" href="../fundamentals/tracks.html"><span class="doc std std-doc">tracks layer fundamentals tutorial</span></a>.</p>
<p>This application note covers two examples:</p>
<ol class="simple">
<li><p>Visualization of a cell tracking challenge dataset</p></li>
<li><p>Single cell tracking using btrack and napari</p></li>
</ol>
<div class="section" id="cell-tracking-challenge-data">
<h2>1. cell tracking challenge data<a class="headerlink" href="#cell-tracking-challenge-data" title="Permalink to this headline">¶</a></h2>
<p>The first example of track visualization uses data from the <a class="reference external" href="http://celltrackingchallenge.net/3d-datasets/">cell tracking challenge</a>. We will use the <em>C. elegans</em> developing embryo <a class="reference external" href="http://data.celltrackingchallenge.net/training-datasets/Fluo-N3DH-CE.zip">dataset</a> which consists of 3D+t volumetric imaging data, manually annotated tracks and cell lineage information.</p>
<p>A full description of the data format can be found <a class="reference external" href="https://public.celltrackingchallenge.net/documents/Naming%20and%20file%20content%20conventions.pdf">here</a>.</p>
<div class="section" id="extracting-the-tracks-from-the-dataset">
<h3>extracting the tracks from the dataset<a class="headerlink" href="#extracting-the-tracks-from-the-dataset" title="Permalink to this headline">¶</a></h3>
<p>We need to extract the centroids of each cell and their associated track labels from the annotated dataset. We start by loading the images containing the centroids and unique track labels:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">napari</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">skimage.io</span> <span class="kn">import</span> <span class="n">imread</span>
<span class="kn">from</span> <span class="nn">skimage.measure</span> <span class="kn">import</span> <span class="n">regionprops_table</span>

<span class="n">PATH</span> <span class="o">=</span> <span class="s1">&#39;/path/to/Fluo-N3DH-CE/&#39;</span>
<span class="n">NUM_IMAGES</span> <span class="o">=</span> <span class="mi">195</span>

<span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load an image from the sequence.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    idx : int</span>
<span class="sd">        Index of the image to load.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    image : np.ndarray</span>
<span class="sd">       The image specified by the index, idx</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH</span><span class="p">,</span> <span class="s1">&#39;01_GT/TRA&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;man_track</span><span class="si">{</span><span class="n">idx</span><span class="si">:</span><span class="s1">0&gt;3</span><span class="si">}</span><span class="s1">.tif&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">imread</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">load_image</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_IMAGES</span><span class="p">)])</span>
</pre></div>
</div>
<p>For each image in the time-lapse sequence, we will now extract the unique track label (<code class="docutils literal notranslate"><span class="pre">track_id</span></code>), centroid and timestamp in order to create the track data we will pass to the <code class="docutils literal notranslate"><span class="pre">Tracks</span></code> layer. For more information on the format of the track data, please see the “tracks data” section of the <a class="reference internal" href="../fundamentals/tracks.html"><span class="doc std std-doc">tracks layer fundamentals tutorial</span></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">regionprops_plus_time</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the unique track label, centroid and time for each track vertex.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    idx : int</span>
<span class="sd">        Index of the image to calculate the centroids and track labels.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    data_df : pd.DataFrame</span>
<span class="sd">       The dataframe of track data for one time step (specified by idx).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">props</span> <span class="o">=</span> <span class="n">regionprops_table</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">properties</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;centroid&#39;</span><span class="p">))</span>
    <span class="n">props</span><span class="p">[</span><span class="s1">&#39;frame&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>

<span class="n">data_df_raw</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
    <span class="p">[</span><span class="n">regionprops_plus_time</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_IMAGES</span><span class="p">)]</span>
<span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># sort the data lexicographically by track_id and time</span>
<span class="n">data_df</span> <span class="o">=</span> <span class="n">data_df_raw</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;frame&#39;</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># create the final data array: track_id, T, Z, Y, X</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="p">:,</span> <span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;frame&#39;</span><span class="p">,</span> <span class="s1">&#39;centroid-0&#39;</span><span class="p">,</span> <span class="s1">&#39;centroid-1&#39;</span><span class="p">,</span> <span class="s1">&#39;centroid-2&#39;</span><span class="p">]</span>
<span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</pre></div>
</div>
<p>This represents the minimum amount of information to display tracks in napari, and can already be visualised.
At this point, there is no concept of track <em>links</em>, lineages, or tracks splitting or merging.
These single tracks are sometimes known as tracklets:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">napari</span><span class="o">.</span><span class="n">gui_qt</span><span class="p">():</span>
    <span class="n">napari</span><span class="o">.</span><span class="n">view_tracks</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;tracklets&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="calculating-the-graph-using-the-lineage-information">
<h3>calculating the graph using the lineage information<a class="headerlink" href="#calculating-the-graph-using-the-lineage-information" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">Tracks</span></code> layer can also be used to visualize a track ‘graph’ using the additional keyword argument <code class="docutils literal notranslate"><span class="pre">graph</span></code>. The <code class="docutils literal notranslate"><span class="pre">graph</span></code>  represents associations between tracks, by defining the
mapping between a <code class="docutils literal notranslate"><span class="pre">track_id</span></code> and the parents of the track. This graph can be useful in single cell tracking to understand the lineage of cells over multiple cell division events. For more information on the format of the track <code class="docutils literal notranslate"><span class="pre">graph</span></code>, please see the “tracks graph” section of the <a class="reference internal" href="../fundamentals/tracks.html"><span class="doc std std-doc">tracks layer fundamentals tutorial</span></a>.</p>
<p>In the cell tracking challenge dataset, cell lineage information is stored in a text file <code class="docutils literal notranslate"><span class="pre">man_track.txt</span></code> in the following format:</p>
<blockquote>
<div><p>A text file representing an acyclic graph for the whole video. Every line corresponds
to a single track that is encoded by four numbers separated by a space:
L - a unique label of the track (label of markers, 16-bit positive value)
B - a zero-based temporal index of the frame in which the track begins
E - a zero-based temporal index of the frame in which the track ends
P - label of the parent track (0 is used when no parent is defined)</p>
</div></blockquote>
<p>To extract the graph, we load the text file and convert it to a Nx4 integer numpy array, where the rows represent individual tracks and the columns represent L, B, E and P:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">lbep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH</span><span class="p">,</span> <span class="s1">&#39;01_GT/TRA&#39;</span><span class="p">,</span> <span class="s1">&#39;man_track.txt&#39;</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint</span><span class="p">)</span>
</pre></div>
</div>
<p>We can then create a dictionary representing the graph, where the key is the unique track label (L) and the value is the label of the parent track (P).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">full_graph</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lbep</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]])</span>
</pre></div>
</div>
<p>Finally, we remove the root nodes (<em>i.e.</em> cells without a parent) for visualization with the <code class="docutils literal notranslate"><span class="pre">Tracks</span></code> layer:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">graph</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">full_graph</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="traversing-the-lineage-trees-to-identify-the-root-nodes">
<h3>traversing the lineage trees to identify the root nodes<a class="headerlink" href="#traversing-the-lineage-trees-to-identify-the-root-nodes" title="Permalink to this headline">¶</a></h3>
<p>One property that is useful to visualize in single cell tracking is the <code class="docutils literal notranslate"><span class="pre">track_id</span></code> of the root node of the lineage trees, <em>i.e.</em> the founder cell.
We create it with the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">root</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Recursive function to determine the root node of each subgraph.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    node : int</span>
<span class="sd">        the track_id of the starting graph node.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    root_id : int</span>
<span class="sd">       The track_id of the root of the track specified by node.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">full_graph</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># we found the root</span>
        <span class="k">return</span> <span class="n">node</span>
    <span class="k">return</span> <span class="n">root</span><span class="p">(</span><span class="n">full_graph</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>

<span class="n">roots</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">root</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">full_graph</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Tracks</span></code> layer enables the vertices of the tracks to be colored by user specified properties. Here, we will create a property which represents the <code class="docutils literal notranslate"><span class="pre">root_id</span></code> of each tree, so that cells with a common ancestor are colored the same:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;root_id&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">roots</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]]}</span>
</pre></div>
</div>
</div>
<div class="section" id="visualizing-the-tracks-with-napari">
<h3>visualizing the tracks with napari<a class="headerlink" href="#visualizing-the-tracks-with-napari" title="Permalink to this headline">¶</a></h3>
<p>Alongside the tracks, we can also visualize the fluorescence imaging data.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">timelapse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
    <span class="p">[</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH</span><span class="p">,</span> <span class="s1">&#39;01&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;t</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s1">0&gt;3</span><span class="si">}</span><span class="s1">.tif&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_IMAGES</span><span class="p">)]</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Finally, we need to adjust the scaling of the data to account for the anisotropic nature of the images. We can use the <code class="docutils literal notranslate"><span class="pre">scale</span></code> feature of napari layers to set the voxel size where the z dimension is different to the size in the x and y dimensions. From the dataset, the voxel size (XYZ) in microns is 0.09 x 0.09 x 1.0. Therefore we can set the scale for the layers as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># scale factor for dimensions in TZYX order</span>
<span class="n">SCALE</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.09</span><span class="p">,</span> <span class="mf">0.09</span><span class="p">)</span>
</pre></div>
</div>
<p>We can now visualize the full, linked tracks in napari!
Remember that we need to initialize and interact with the napari viewer in the <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">napari.gui_qt()</span></code> context manager in order to ensure the GUI is properly initialized.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">napari</span><span class="o">.</span><span class="n">gui_qt</span><span class="p">():</span>
    <span class="n">viewer</span> <span class="o">=</span> <span class="n">napari</span><span class="o">.</span><span class="n">Viewer</span><span class="p">()</span>
    <span class="n">viewer</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span><span class="n">timelapse</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">SCALE</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Fluo-N3DH-CE&#39;</span><span class="p">)</span>
    <span class="n">viewer</span><span class="o">.</span><span class="n">add_tracks</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="n">graph</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">SCALE</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;tracks&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="image: tracks isbi" src="../_images/tracks_isbi.gif" /></p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="using-btrack-to-track-cells">
<h2>2. using <code class="docutils literal notranslate"><span class="pre">btrack</span></code> to track cells<a class="headerlink" href="#using-btrack-to-track-cells" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">btrack</span></code> library can be used for cell tracking. It provides a convenient <code class="docutils literal notranslate"><span class="pre">to_napari()</span></code> function to enable rapid visualization of the tracking results. You can learn more about the <code class="docutils literal notranslate"><span class="pre">btrack</span></code> library <a class="reference external" href="https://github.com/quantumjot/BayesianTracker">here</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">btrack</span>
</pre></div>
</div>
<p>We start by loading a file containing the centroids of all the found cells in each frame of the source movie. Note that this file only contains the locations of cells in the movie, there are no tracks yet. We can use the <code class="docutils literal notranslate"><span class="pre">btrack</span></code> library to load this file as a list of <code class="docutils literal notranslate"><span class="pre">objects</span></code> that contain information about each found cell, including the TZYX position.  The example dataset can be downloaded <a class="reference external" href="https://raw.githubusercontent.com/quantumjot/BayesianTracker/master/examples/napari_example.csv">here</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">objects</span> <span class="o">=</span> <span class="n">btrack</span><span class="o">.</span><span class="n">dataio</span><span class="o">.</span><span class="n">import_CSV</span><span class="p">(</span><span class="s1">&#39;napari_example.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Next, we set up a <code class="docutils literal notranslate"><span class="pre">btrack.BayesianTracker</span></code> instance using a context manager to ensure the library is properly initialized. The <code class="docutils literal notranslate"><span class="pre">objects</span></code> are added to the tracker using the <code class="docutils literal notranslate"><span class="pre">.append()</span></code> method. We also set the imaging volume using the <code class="docutils literal notranslate"><span class="pre">volume</span></code> property. As this is a 2D dataset, the limits of the volume are set to the XY dimensions of the image dataset, while the Z dimension is set to be very large (±1e5). In this case, setting the Z limits of the volume to be very large penalises tracks which initialize or terminate in the centre of the XY plane, unless they can be explained by corresponding cell division or death events.</p>
<p>The tracker performs the process of linking individual cell observations into tracks and the generating the associated track graph:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">btrack</span><span class="o">.</span><span class="n">BayesianTracker</span><span class="p">()</span> <span class="k">as</span> <span class="n">tracker</span><span class="p">:</span>

    <span class="c1"># configure the tracker using a config file</span>
    <span class="n">tracker</span><span class="o">.</span><span class="n">configure_from_file</span><span class="p">(</span><span class="s1">&#39;cell_config.json&#39;</span><span class="p">)</span>

    <span class="n">tracker</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
    <span class="n">tracker</span><span class="o">.</span><span class="n">volume</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1600</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1200</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mf">1e5</span><span class="p">,</span><span class="mf">1e5</span><span class="p">))</span>

    <span class="c1"># track and optimize</span>
    <span class="n">tracker</span><span class="o">.</span><span class="n">track_interactive</span><span class="p">(</span><span class="n">step_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">tracker</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>

    <span class="c1"># get the tracks in a format for napari visualization</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">graph</span> <span class="o">=</span> <span class="n">tracker</span><span class="o">.</span><span class="n">to_napari</span><span class="p">(</span><span class="n">ndim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>We set the configuration of the tracker using a configuration file using the <code class="docutils literal notranslate"><span class="pre">.configure_from_file()</span></code> method. An example configuration file can be found <a class="reference external" href="https://github.com/quantumjot/BayesianTracker/blob/master/models/cell_config.json">here</a>.</p>
<p>Next, the objects are linked into tracks using the <code class="docutils literal notranslate"><span class="pre">.track_interactive()</span></code> method. The <code class="docutils literal notranslate"><span class="pre">step_size</span></code> argument specifies how many steps are taken before reporting the tracking statistics. The <code class="docutils literal notranslate"><span class="pre">.optimize()</span></code> method then performs a global optimization on the dataset and creates lineage trees automatically.</p>
<p>Finally, the <code class="docutils literal notranslate"><span class="pre">.to_napari()</span></code> method returns the track vertices, track properties and graph in a format that can be directly visualized using the napari <code class="docutils literal notranslate"><span class="pre">Tracks</span></code> layer:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">napari</span><span class="o">.</span><span class="n">gui_qt</span><span class="p">():</span>
    <span class="n">viewer</span> <span class="o">=</span> <span class="n">napari</span><span class="o">.</span><span class="n">Viewer</span><span class="p">()</span>
    <span class="n">viewer</span><span class="o">.</span><span class="n">add_tracks</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="n">graph</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="image: tracks btrack" src="../_images/tracks_btrack.png" /></p>
<p>A notebook for this example can be found in the btrack examples directory (<a class="reference external" href="https://github.com/quantumjot/BayesianTracker/blob/caa56fa82330e4b16b5d28150f9b60ed963165c7/examples/napari_btrack.ipynb"><code class="docutils literal notranslate"><span class="pre">napari_btrack.ipynb</span></code></a>)</p>
</div>
<div class="section" id="summary">
<h2>summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>In this application note, we have used napari to track and visualize single cells.</p>
</div>
<div class="section" id="further-reading">
<h2>further reading<a class="headerlink" href="#further-reading" title="Permalink to this headline">¶</a></h2>
<p>References for cell tracking challenge:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.nature.com/articles/nmeth.1228">https://www.nature.com/articles/nmeth.1228</a></p></li>
<li><p><a class="reference external" href="http://dx.doi.org/10.1093/bioinformatics/btu080">http://dx.doi.org/10.1093/bioinformatics/btu080</a></p></li>
<li><p><a class="reference external" href="http://dx.doi.org/10.1038/nmeth.4473">http://dx.doi.org/10.1038/nmeth.4473</a></p></li>
</ul>
<p>For a more advanced example of visualizing cell tracking data with napari, please see the Arboretum plugin for napari:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/quantumjot/BayesianTracker">btrack</a></p></li>
<li><p><a class="reference external" href="https://github.com/quantumjot/arboretum">arboretum</a></p></li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./applications"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="napari_imageJ.html" title="previous page">Napari + ImageJ How-to-Guide</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By The Jupyter Book community<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../_static/js/index.d3f166471bb80abb5163.js"></script>


    
  </body>
</html>